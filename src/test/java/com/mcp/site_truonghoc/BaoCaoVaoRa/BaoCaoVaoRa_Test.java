package com.mcp.site_truonghoc.BaoCaoVaoRa;

import com.mcp.site_truonghoc.LoginMethod;
import com.mcp.site_truonghoc.config.ConfigManager;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.testng.annotations.*;

import java.io.File;
import java.time.Duration;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.Map;

public class BaoCaoVaoRa_Test {
    private WebDriver driver;
    private WebDriverWait wait;
    private BaoCaoVaoRa_Page baoCaoVaoRaPage;

    private final String downloadPath = getDownloadPath();

    private String getDownloadPath() {
        String path;
        boolean isCI = false;

        // Ki·ªÉm tra c√°c d·∫•u hi·ªáu c·ªßa m√¥i tr∆∞·ªùng CI
        String ciEnv = System.getenv("CI");
        String githubActions = System.getenv("GITHUB_ACTIONS");
        String runnerTemp = System.getenv("RUNNER_TEMP");
        String runnerWork = System.getenv("RUNNER_WORKSPACE");

        if (ciEnv != null && ciEnv.equals("true") ||
                githubActions != null && githubActions.equals("true") ||
                runnerTemp != null) {
            isCI = true;
        }

        if (isCI) {
            // Tr√™n CI (GitHub Actions)
            if (runnerWork != null) {
                path = runnerWork + "/QC_site_truonghoc/downloads";
            } else {
                path = "/home/runner/work/QC_site_truonghoc/QC_site_truonghoc/downloads";
            }
            System.out.println("üîÑ ƒêang ch·∫°y trong m√¥i tr∆∞·ªùng CI");
            System.out.println("CI: " + ciEnv);
            System.out.println("GITHUB_ACTIONS: " + githubActions);
            System.out.println("RUNNER_WORKSPACE: " + runnerWork);
        } else {
            // Tr√™n local
            path = System.getProperty("user.dir") + File.separator + "downloads";
            System.out.println("üîÑ ƒêang ch·∫°y trong m√¥i tr∆∞·ªùng local");
            System.out.println("Th∆∞ m·ª•c d·ª± √°n: " + System.getProperty("user.dir"));
        }

        System.out.println("üìÅ ƒê∆∞·ªùng d·∫´n th∆∞ m·ª•c t·∫£i v·ªÅ: " + path);
        return path;
    }

    @BeforeClass
    public void setup() {
        String osName = System.getProperty("os.name").toLowerCase();
        String projectDir = System.getProperty("user.dir");
        String chromeDriverPath;
        
        if (osName.contains("windows")) {
            chromeDriverPath = projectDir + File.separator + "chromedriver-win64" + 
                File.separator + "135.0.7049.95" + File.separator + "chromedriver.exe";
        } else {
            chromeDriverPath = projectDir + File.separator + "chromedriver-linux64" + 
                File.separator + "chromedriver";
        }
        
        System.out.println("S·ª≠ d·ª•ng ChromeDriver t·∫°i: " + chromeDriverPath);
        System.setProperty("webdriver.chrome.driver", chromeDriverPath);
        
        // Kh·ªüi t·∫°o ChromeOptions
        ChromeOptions options = new ChromeOptions();
        options.addArguments("--remote-allow-origins=*");
        options.addArguments("--disable-popup-blocking");
        options.addArguments("--disable-notifications");
        options.addArguments("--safebrowsing-disable-download-protection");
        options.addArguments("--disable-web-security");
        options.addArguments("--no-sandbox");
        options.addArguments("--disable-dev-shm-usage");
        options.addArguments("--headless=new"); // Ch·∫°y ·ªü ch·∫ø ƒë·ªô kh√¥ng hi·ªÉn th·ªã
        options.addArguments("--disable-gpu");
        options.addArguments("--window-size=1920,1080");
        options.addArguments("--start-maximized");
        
        // C·∫•u h√¨nh download
        Map<String, Object> prefs = new HashMap<>();
        prefs.put("download.default_directory", downloadPath);
        prefs.put("download.prompt_for_download", false);
        prefs.put("safebrowsing.enabled", false);
        prefs.put("download.directory_upgrade", true);
        prefs.put("browser.download.folderList", 2);
        prefs.put("browser.download.manager.showWhenStarting", false);
        prefs.put("browser.helperApps.neverAsk.saveToDisk", 
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet," +
            "application/vnd.ms-excel,application/x-excel,application/x-msexcel," +
            "application/octet-stream");
        options.setExperimentalOption("prefs", prefs);
        
        driver = new ChromeDriver(options);
        driver.manage().window().maximize();
        driver.manage().timeouts().implicitlyWait(Duration.ofSeconds(10));
        wait = new WebDriverWait(driver, Duration.ofSeconds(10));
        baoCaoVaoRaPage = new BaoCaoVaoRa_Page(driver);
    }

    @BeforeMethod
    public void setUp() {
        // Kh√¥ng c·∫ßn kh·ªüi t·∫°o l·∫°i ChromeDriver
        System.out.println("\nüîÑ ƒêang chu·∫©n b·ªã test case...");
    }

    @AfterMethod
    public void tearDown() {
        try {
            // ƒêƒÉng xu·∫•t tr∆∞·ªõc khi k·∫øt th√∫c test case
            System.out.println("\nüîÑ ƒêang ƒëƒÉng xu·∫•t...");
            performLogout();
            System.out.println("‚úÖ ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng");
        } catch (Exception e) {
            System.out.println("‚ö†Ô∏è Kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t: " + e.getMessage());
        }
        System.out.println("\nüîÑ ƒê√£ ho√†n th√†nh test case");
    }

    private void performLogout() {
        try {
            // Click v√†o n√∫t h·ªì s∆°
            WebElement profileButton = wait.until(ExpectedConditions.elementToBeClickable(By.cssSelector("button[title='H·ªì s∆°']")));
            profileButton.click();
            Thread.sleep(1000);

            // Click v√†o n√∫t ƒëƒÉng xu·∫•t
            WebElement logoutButton = wait.until(ExpectedConditions.elementToBeClickable(By.cssSelector("li[class*='logout']")));
            logoutButton.click();
            Thread.sleep(1000);

            // ƒê·ª£i cho ƒë·∫øn khi URL ch·ª©a "/#"
            wait.until(ExpectedConditions.urlContains("/#"));
        } catch (Exception e) {
            throw new RuntimeException("Kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t: " + e.getMessage());
        }
    }

    @AfterClass
    public void tearDownClass() {
        System.out.println("\n=== K·∫æT TH√öC T·∫§T C·∫¢ TEST CASE ===");
        if (driver != null) {
            driver.quit();
        }
        cleanDownloadDirectory();
    }

    private void cleanDownloadDirectory() {
        File downloadDir = new File(downloadPath);
        if (downloadDir.exists()) {
            File[] files = downloadDir.listFiles((dir, name) ->
                    name.toLowerCase().endsWith(".xlsx") ||
                            name.toLowerCase().endsWith(".xls"));
            if (files != null) {
                for (File file : files) {
                    if(file.delete()) {
                        System.out.println("‚úÖ ƒê√£ x√≥a file: " + file.getName());
                    } else {
                        System.out.println("‚ö†Ô∏è Kh√¥ng th·ªÉ x√≥a file: " + file.getName());
                        // Th·ª≠ ƒë·ªïi t√™n file n·∫øu kh√¥ng x√≥a ƒë∆∞·ª£c
                        File renamedFile = new File(file.getParent(), "old_" + file.getName());
                        if(file.renameTo(renamedFile)) {
                            System.out.println("‚úÖ ƒê√£ ƒë·ªïi t√™n file: " + file.getName() + " -> " + renamedFile.getName());
                        }
                    }
                }
            }
        }
    }

    @Test(priority = 1, description = "Xu·∫•t b√°o c√°o Excel v·ªõi ng√†y trong t∆∞∆°ng lai")
    public void testBaoCaoVaoRa_NgayTuongLai() throws InterruptedException {
        try {
            System.out.println("\n=== TEST CASE 1: XU·∫§T B√ÅO C√ÅO NG√ÄY T∆Ø∆†NG LAI ===");
            // L·∫•y ng√†y hi·ªán t·∫°i + 2 ng√†y
            String futureDate = java.time.LocalDate.now().plusDays(2).format(java.time.format.DateTimeFormatter.ofPattern("dd-MM-yyyy"));
            executeTest(futureDate);
        } catch (Exception e) {
            System.err.println("\n‚ùå L·ªñI TRONG QU√Å TR√åNH KI·ªÇM TH·ª¨");
            System.err.println("Chi ti·∫øt l·ªói: " + e.getMessage());
            e.printStackTrace();
            throw e;
        }
    }

    @Test(priority = 2, description = "Xu·∫•t b√°o c√°o Excel v·ªõi ng√†y hi·ªán t·∫°i")
    public void testBaoCaoVaoRa_NgayHienTai() throws InterruptedException {
        try {
            System.out.println("\n=== TEST CASE 2: XU·∫§T B√ÅO C√ÅO NG√ÄY HI·ªÜN T·∫†I ===");
            // L·∫•y ng√†y hi·ªán t·∫°i
            String currentDate = java.time.LocalDate.now().format(java.time.format.DateTimeFormatter.ofPattern("dd-MM-yyyy"));
            executeTest(currentDate);
        } catch (Exception e) {
            System.err.println("\n‚ùå L·ªñI TRONG QU√Å TR√åNH KI·ªÇM TH·ª¨");
            System.err.println("Chi ti·∫øt l·ªói: " + e.getMessage());
            e.printStackTrace();
            throw e;
        }
    }

    @Test(priority = 3, description = "Xu·∫•t b√°o c√°o Excel v·ªõi ng√†y trong qu√° kh·ª©")
    public void testBaoCaoVaoRa_NgayQuaKhu() throws InterruptedException {
        try {
            System.out.println("\n=== TEST CASE 3: XU·∫§T B√ÅO C√ÅO NG√ÄY QU√Å KH·ª® ===");
            // L·∫•y ng√†y hi·ªán t·∫°i - 2 ng√†y
            String pastDate = java.time.LocalDate.now().minusDays(2).format(java.time.format.DateTimeFormatter.ofPattern("dd-MM-yyyy"));
            executeTest(pastDate);
        } catch (Exception e) {
            System.err.println("\n‚ùå L·ªñI TRONG QU√Å TR√åNH KI·ªÇM TH·ª¨");
            System.err.println("Chi ti·∫øt l·ªói: " + e.getMessage());
            e.printStackTrace();
            throw e;
        }
    }

    private void executeTest(String testDate) throws InterruptedException {
        try {

            LoginMethod.login(driver);
            Thread.sleep(2000);


            System.out.println("\n2Ô∏è‚É£ TRUY C·∫¨P TRANG B√ÅO C√ÅO");
            System.out.println("‚û°Ô∏è ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn trang b√°o c√°o v√†o/ra");
            System.out.println("üåê URL b√°o c√°o: " + ConfigManager.getUrl("report.inOutUrl"));
            driver.get(ConfigManager.getUrl("report.inOutUrl"));
            Thread.sleep(2000);
            System.out.println("‚úÖ ƒê√£ v√†o trang b√°o c√°o");

            System.out.println("\n3Ô∏è‚É£ CH·ªåN PH√íNG BAN");
            System.out.println("‚û°Ô∏è Click v√†o label Ch·ªçn t·∫•t c·∫£");
            baoCaoVaoRaPage.label.click();
            Thread.sleep(1500);
            System.out.println("‚úÖ ƒê√£ ch·ªçn ph√≤ng ban");

            System.out.println("\n4Ô∏è‚É£ NH·∫¨P NG√ÄY B√ÅO C√ÅO");
            System.out.println("‚û°Ô∏è X√≥a d·ªØ li·ªáu c≈© v√† nh·∫≠p ng√†y: " + testDate);
            baoCaoVaoRaPage.inputUndefinedDate.clear();
            baoCaoVaoRaPage.inputUndefinedDate.sendKeys(testDate);
            Thread.sleep(3000);
            System.out.println("‚úÖ ƒê√£ nh·∫≠p ng√†y b√°o c√°o");

            System.out.println("\n5Ô∏è‚É£ CH·ªåN S·ª∞ KI·ªÜN ƒêI·ªÇM DANH S√ÅNG");
            System.out.println("‚û°Ô∏è Click v√†o input s·ª± ki·ªán");
            baoCaoVaoRaPage.inputEvent.click();
            Thread.sleep(1000);
            System.out.println("‚û°Ô∏è Click v√†o s·ª± ki·ªán ƒëi·ªÉm danh s√°ng");
            baoCaoVaoRaPage.DiemDanhSang.click();
            Thread.sleep(1500);
            System.out.println("‚úÖ ƒê√£ ch·ªçn s·ª± ki·ªán ƒëi·ªÉm danh s√°ng");

            System.out.println("\n6Ô∏è‚É£ XU·∫§T B√ÅO C√ÅO EXCEL");
            System.out.println("‚û°Ô∏è Click n√∫t xu·∫•t Excel");
            baoCaoVaoRaPage.spanExcel.click();
            System.out.println("‚úÖ ƒê√£ click n√∫t xu·∫•t Excel");
            Thread.sleep(3000);

            System.out.println("\n7Ô∏è‚É£ KI·ªÇM TRA FILE T·∫¢I V·ªÄ");
            System.out.println("‚û°Ô∏è Th∆∞ m·ª•c t·∫£i v·ªÅ: " + downloadPath);

            verifyFileDownload();
        } catch (Exception e) {
            System.err.println("\n‚ùå L·ªñI TRONG QU√Å TR√åNH KI·ªÇM TH·ª¨");
            System.err.println("Chi ti·∫øt l·ªói: " + e.getMessage());
            e.printStackTrace();
            throw e;
        }
    }

    private void verifyFileDownload() throws InterruptedException {
        // Ki·ªÉm tra m√¥i tr∆∞·ªùng CI
        boolean isCI = false;
        String ciEnv = System.getenv("CI");
        String githubActions = System.getenv("GITHUB_ACTIONS");

        if (ciEnv != null && ciEnv.equals("true") ||
                githubActions != null && githubActions.equals("true")) {
            isCI = true;
            System.out.println("üîÑ ƒêang ch·∫°y trong m√¥i tr∆∞·ªùng CI");
            return;
        }

        boolean fileDownloaded = false;
        File downloadedFile = null;
        int maxAttempts = 10;
        int waitTime = 2000;

        for (int i = 0; i < maxAttempts && !fileDownloaded; i++) {
            Thread.sleep(waitTime);
            System.out.println("‚è≥ Ki·ªÉm tra l·∫ßn " + (i + 1) + "/" + maxAttempts);

            File[] files = new File(downloadPath).listFiles(
                    (dir, name) -> name.toLowerCase().endsWith(".xlsx") ||
                            name.toLowerCase().endsWith(".xls"));

            if (files != null && files.length > 0) {
                for (File file : files) {
                    if (file.length() > 0) {
                        fileDownloaded = true;
                        downloadedFile = file;
                        System.out.println("‚úÖ T√¨m th·∫•y file Excel: " + file.getName() + " (" + file.length() + " bytes)");
                        break;
                    } else {
                        System.out.println("‚ö†Ô∏è File r·ªóng: " + file.getName());
                    }
                }
            }

            if (!fileDownloaded) {
                System.out.println("üìÅ N·ªôi dung th∆∞ m·ª•c t·∫£i v·ªÅ:");
                File[] allFiles = new File(downloadPath).listFiles();
                if (allFiles != null) {
                    for (File file : allFiles) {
                        System.out.println("   - " + file.getName() + " (" + file.length() + " bytes)");
                    }
                } else {
                    System.out.println("   - Th∆∞ m·ª•c tr·ªëng");
                }
            }
        }

        if (!fileDownloaded || downloadedFile == null) {
            System.err.println("‚ùå Kh√¥ng t√¨m th·∫•y file Excel sau " + maxAttempts + " l·∫ßn ki·ªÉm tra");
            System.err.println("üìÅ N·ªôi dung th∆∞ m·ª•c t·∫£i v·ªÅ:");
            File[] allFiles = new File(downloadPath).listFiles();
            if (allFiles != null) {
                for (File file : allFiles) {
                    System.err.println("   - " + file.getName() + " (" + file.length() + " bytes)");
                }
            }
            throw new RuntimeException("Kh√¥ng t√¨m th·∫•y file Excel ƒë∆∞·ª£c t·∫£i v·ªÅ");
        }

        System.out.println("‚úÖ T·∫£i file th√†nh c√¥ng: " + downloadedFile.getName());
        System.out.println("üìä K√≠ch th∆∞·ªõc file: " + downloadedFile.length() + " bytes");

        Thread.sleep(2000);

        System.out.println("\n=== K·∫æT TH√öC TEST CASE - TH√ÄNH C√îNG ===\n");
    }
} 